// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "cargo prisma"
  output   = "../src/prisma.rs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  Male
  Female
  Other
}

enum Role {
  Employee
  Manager
  Owner
  Admin
}

model User {
  pk_user_id String @id @map("pk_user_id") // Assuming this is a generated ID

  username String @unique
  email    String @unique

  password           String
  department_id      String?
  organize_id        String?
  pagination_id      Int      @unique @default(autoincrement()) @map("pagination_id")
  first_name         String?
  last_name          String?
  gender             Gender   @default(Male)
  role               Role     @default(Employee)
  introduction_brief String?
  image              String?
  total_credit       Int      @default(0)
  is_deleted         Boolean  @default(false)
  deleted_at         Int?
  created_at         DateTime @default(now())
  updated_at         DateTime @default(now())

  KeyResult         KeyResult[]
  ObjectiveOnUser   ObjectiveOnUser[]
  Organize          Organize[]
  Folder            Folder[]
  File              File[]
  sharedToMeFolders Folder[]          @relation("FolderCollaborator")
  sharedToMeFiles   File[]            @relation("FileCollaborator")
  Tag               Tag[]

  Objective Objective[]
}

model Department {
  pk_department_id String  @id @unique
  organize_id      String
  manager_id       String?
  name             String  @unique

  organize              Organize                @relation(fields: [organize_id], references: [pk_organize_id], onDelete: SetNull)
  ObjectiveOnDepartment ObjectiveOnDepartment[]
}

model Organize {
  pk_organize_id String @id @unique
  owner_id       String
  name           String @unique
  address        String
  contact        String

  owner          User             @relation(fields: [owner_id], references: [pk_user_id], onDelete: SetNull)
  Department     Department[]
  Period         Period[]
  ObjectiveOnOrg ObjectiveOnOrg[]
}

enum objective_metric {
	Quantity
	Percent
	Time 
	Money
}

enum Achievement {
	Achievement
	NonAchievement
	Exceed
	Other
}

enum objective_for{
	User
	Department
	Organize
}

model Objective {
  pk_objective_id       String                  @id @unique 
  period_id             String
  parent_objective_id   String?
  Parent_obj            Objective?               @relation("NestedObj", fields: [parent_objective_id], references: [pk_objective_id], onDelete: Cascade)
  

  period                Period                  @relation(fields: [period_id], references: [pk_period_id], onDelete: SetNull)
  obj_type              objective_type          @default(Other)
  obj_for               objective_for
  supervisor_id         String
  expected              Float
  metric                objective_metric
  achievement           Achievement?
  user                  User                    @relation(fields: [supervisor_id], references: [pk_user_id], onDelete: SetNull)
  name                  String
  description           String?
  target                Float
  progress              Float?                  @default(0)
  status                Boolean                 @default(true)
  created_at            DateTime                @default(now())
  updated_at            DateTime                @updatedAt
  deadline              DateTime
  childObjectives             Objective[]       @relation("NestedObj")
  KeyResult             KeyResult[]
  ObjectiveOnDepartment ObjectiveOnDepartment[]
  ObjectiveOnUser       ObjectiveOnUser[]
  ObjectiveOnOrg        ObjectiveOnOrg[]
}

enum objective_type {
  Percent
  As_high_as_possible
  As_low_as_possible
  Kpi
  Other
}

model UserInformation {
  pk_user_id         String   @id @unique
  job_title          String?
  location           String?
  company            String?
  bio                String?
  job_type           String?
  year_of_experience Int?
  industry           String?
  birthday           BigInt?
  organization       String?
  education_level    String?
  education          String?
  social_link        String[]
}

model OAuthStateStorage {
  csrf_state         String @id @unique
  pkce_code_verifier String
}

model Notification {
  pk_notification_id String  @id @unique
  user_id            String
  message            String
  status             Boolean @default(false)
  timestamp          DateTime  @default(now())
}


model KeyResult {
  pk_kr_id String @id @map("pk_kr_id")

  objective_id String
  objective   Objective @relation(fields: [objective_id], references: [pk_objective_id], onDelete: Cascade)

  name String

  description String

  target Float 

  progress Float @default(0)

  status Boolean @default(false)

  supervisor_grade Float @default(0)

  metric String

  deadline DateTime

  user_id String
  user   User   @relation(fields: [user_id], references: [pk_user_id], onDelete: SetNull)

  created_at DateTime @default(now())

  updated_at DateTime @updatedAt
}

model Period {
  pk_period_id String   @id @map("pk_period_id")
  organize_id  String
  name         String
  start_date   DateTime
  end_date     DateTime

  Objective Objective[]
  Organize  Organize    @relation(fields: [organize_id], references: [pk_organize_id], onDelete: SetNull)
}

model ObjectiveOnDepartment {
  id            String     @id @default(uuid())
  obj_id        String
  department_id String
  objective     Objective  @relation(fields: [obj_id], references: [pk_objective_id], onDelete: Cascade)
  department    Department @relation(fields: [department_id], references: [pk_department_id], onDelete: Cascade)

  @@unique([obj_id, department_id], map: "uc_obj_department")
  @@index([obj_id], map: "obj_departments_obj")
  @@index([department_id], map: "obj_departments_department")
}

model ObjectiveOnUser {
  id        String    @id @default(uuid())
  obj_id    String
  user_id   String
  objective Objective @relation(fields: [obj_id], references: [pk_objective_id], onDelete: Cascade)
  user      User      @relation(fields: [user_id], references: [pk_user_id], onDelete: Cascade)

  @@unique([obj_id, user_id], map: "uc_obj_user")
  @@index([obj_id], map: "obj_users_obj")
  @@index([user_id], map: "obj_users_user")
}

model ObjectiveOnOrg {
  id        String    @id @default(uuid())
  obj_id    String
  org_id    String
  objective Objective @relation(fields: [obj_id], references: [pk_objective_id], onDelete: Cascade)
  org       Organize  @relation(fields: [org_id], references: [pk_organize_id], onDelete: Cascade)

  @@unique([obj_id, org_id], map: "uc_obj_org")
  @@index([obj_id], map: "obj_orgs_obj")
  @@index([org_id], map: "obj_orgs_organize")
}

model Folder {
  id String @id @default(uuid())

  owner   User   @relation(fields: [ownerId], references: [pk_user_id], onDelete: Cascade)
  ownerId String

  collaborators User[] @relation("FolderCollaborator")

  parentFolder   Folder? @relation("NestedFolders", fields: [parentFolderId], references: [id], onDelete: Cascade)
  parentFolderId String? // Use create_unchecked and update_unchecked to make this work!!!

  childFolders Folder[] @relation("NestedFolders")
  childFiles   File[]

  folderName String
  visibility Visibility
  tags       Tag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ownerId, parentFolderId, folderName])
}

model File {
  id String @id @default(uuid())

  owner   User   @relation(fields: [ownerId], references: [pk_user_id], onDelete: Cascade)
  ownerId String

  collaborators User[] @relation("FileCollaborator")

  parentFolder   Folder @relation(fields: [parentFolderId], references: [id], onDelete: Cascade)
  parentFolderId String

  filename   String
  extension  Extension
  visibility Visibility
  tags       Tag[]
  versions   FileVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ownerId, parentFolderId, filename, extension])
}

model FileVersion {
  id String @id @default(uuid())

  file   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)
  fileId String

  versionNumber BigInt

  @@unique([fileId, versionNumber])
}

model Tag {
  id String @id @default(uuid())

  tagName String

  owner   User   @relation(fields: [ownerId], references: [pk_user_id], onDelete: Cascade)
  ownerId String

  files   File[]
  folders Folder[]

  @@unique([tagName, ownerId])
}

enum Visibility {
  public
  shared
  private
}

enum Extension {
  png
  jpg
  jpeg
  svg
  xlsx
  docx
}
